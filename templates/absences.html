{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
  <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Absence records</p>
        <h1 class="text-2xl font-semibold text-slate-900">Daily absence log</h1>
        <p class="text-sm text-slate-500">Review the recorded leaves and immediately see whether each has an assignment.</p>
      </div>
      <span class="text-xs uppercase tracking-[0.3em] text-slate-400">
        {% if assigned_count or pending_count %}
          {{ assigned_count }} assigned · {{ pending_count }} pending
        {% else %}
          No records selected
        {% endif %}
      </span>
    </div>
    {% if sync_status %}
    <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
      {% if sync_status == "disabled" %}
        Absence sync is not configured. Set ABSENCES_REQUEST_URL to enable manual requests.
      {% elif sync_status == "failed" %}
        Unable to request absences from the server. Check the webhook endpoint and secret.
      {% else %}
        Absence sync requested.{% if sync_added %} Recorded {{ sync_added }} absences.{% endif %}{% if sync_skipped %} Skipped {{ sync_skipped }} entries.{% endif %}
      {% endif %}
    </div>
    {% endif %}
    {% if manual_status %}
    <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
      {% if manual_status == "success" %}
        Manual absence recorded and cover assignment triggered.
      {% else %}
        Manual absence failed{% if manual_reason %}: {{ manual_reason }}{% endif %}.
      {% endif %}
    </div>
    {% endif %}
    {% if clear_status %}
    <div class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-600">
      {% if clear_status == "success" %}
        Removed {{ clear_count }} cover assignment(s). Use "Assign pending absences" to reassign.
      {% else %}
        No assignments were removed for this absence.
      {% endif %}
    </div>
    {% endif %}
    <form method="post" action="{{ url_for('assign_missing_absences') }}" class="flex flex-wrap items-center gap-3">
      <button
        type="submit"
        {% if not pending_count %}disabled{% endif %}
        class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50 disabled:pointer-events-none disabled:opacity-40"
      >
        Assign pending absences ({{ pending_count }})
      </button>
      <p class="text-xs text-slate-500">Re-run assignments for every recorded leave (includes future dates).</p>
    </form>
    <form method="post" action="{{ url_for('request_absences_webhook') }}" class="flex flex-wrap items-center gap-3">
      <button
        type="submit"
        {% if not absences_request_enabled %}disabled{% endif %}
        class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50 disabled:pointer-events-none disabled:opacity-40"
      >
        Request missed absences
      </button>
      <p class="text-xs text-slate-500">Ask the server to resend any absences that were missed.</p>
    </form>
    <form method="post" action="{{ url_for('manual_absence') }}" class="grid gap-3 rounded-2xl border border-slate-200 bg-slate-50 p-4">
      <div class="grid gap-3 md:grid-cols-2">
        <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500">
          Teacher email
          <input
            type="email"
            name="email"
            required
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"
            placeholder="teacher@school.org"
          />
        </label>
        <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500">
          Leave type
          <input
            type="text"
            name="leave_type"
            value="manual"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"
          />
        </label>
      </div>
      <div class="grid gap-3 md:grid-cols-2">
        <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500">
          Start date
          <input
            type="date"
            name="start_date"
            required
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"
          />
        </label>
        <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500">
          End date
          <input
            type="date"
            name="end_date"
            class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"
          />
        </label>
      </div>
      <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500">
        Reason (optional)
        <input
          type="text"
          name="reason"
          class="mt-2 w-full rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700"
          placeholder="Optional note"
        />
      </label>
      <div class="flex flex-wrap items-center gap-3">
        <button
          type="submit"
          class="rounded-full bg-slate-900 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-slate-800"
        >
          Add manual absence
        </button>
        <p class="text-xs text-slate-500">Assignments use the teacher schedule for each day in the range.</p>
      </div>
    </form>
    <form method="get" class="mt-4 flex flex-wrap items-end gap-3">
      <label class="text-[11px] uppercase tracking-[0.3em] text-slate-500" for="absence-date">Choose date</label>
      <select
        name="date"
        id="absence-date"
        class="rounded-2xl border border-slate-200 px-4 py-2 text-sm text-slate-700"
      >
        <option value="" disabled {% if not selected_date %}selected{% endif %}>Select a date</option>
        {% for option in date_options %}
        <option value="{{ option.key }}" {% if option.key == selected_date %}selected{% endif %}>
          {{ option.key }}{% if option.label %} · {{ option.label }}{% endif %}
        </option>
        {% endfor %}
      </select>
      <button
        type="submit"
        class="rounded-2xl bg-slate-900 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-white hover:bg-slate-800"
      >
        Load selection
      </button>
      {% if selected_day_label %}
      <p class="text-xs text-slate-500">Day: <span class="font-semibold text-slate-900">{{ selected_day_label }}</span></p>
      {% endif %}
    </form>
  </section>

  {% if not date_options %}
  <section class="rounded-3xl border border-dashed border-slate-300 bg-white p-6 text-center text-sm text-slate-500 shadow">
    No absences have been recorded yet.
  </section>
  {% else %}
  <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow overflow-auto">
    {% if rows %}
    <div class="flex flex-wrap gap-2 mb-4 no-print">
      <button
        type="button"
        data-table-action="print"
        data-table-target="#absences-table"
        data-table-title="absence log"
        class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50"
      >
        Print table
      </button>
      <button
        type="button"
        data-table-action="save-pdf"
        data-table-target="#absences-table"
        data-table-title="absence log"
        class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50"
      >
        Save PDF
      </button>
      <button
        type="button"
        data-table-action="export"
        data-table-target="#absences-table"
        data-table-title="absence log"
        class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50"
      >
        Export Excel
      </button>
    </div>
    <table id="absences-table" class="min-w-full text-sm text-slate-600">
      <thead class="bg-slate-50 text-xs uppercase tracking-[0.3em] text-slate-400">
        <tr>
          <th class="px-4 py-3 text-left">Teacher</th>
          <th class="px-4 py-3 text-left">Leave type</th>
          <th class="px-4 py-3 text-left">Dates</th>
          <th class="px-4 py-3 text-left">Status</th>
          <th class="px-4 py-3 text-left">Reason</th>
          <th class="px-4 py-3 text-left">Assignment</th>
          <th class="px-4 py-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in rows %}
        <tr class="border-t border-slate-100 text-xs">
          <td class="px-4 py-3">
            <p class="font-semibold text-slate-900">{{ entry.teacher }}</p>
            <p class="text-[11px] text-slate-500">{{ entry.teacher_email or "Email missing" }}</p>
          </td>
          <td class="px-4 py-3">{{ entry.leave_type or "Leave" }}</td>
          <td class="px-4 py-3">
            {{ entry.leave_start }} → {{ entry.leave_end }}
            <p class="text-[11px] text-slate-400">Req {{ entry.request_id or "unknown" }}</p>
          </td>
          <td class="px-4 py-3 text-slate-900">{{ entry.status or "pending" }}</td>
          <td class="px-4 py-3 text-sm text-slate-500">{{ entry.reason or "No reason provided" }}</td>
          <td class="px-4 py-3">
            {% if entry.request_id in assigned_ids %}
            <span class="text-emerald-600 font-semibold uppercase tracking-[0.3em] text-[10px]">Assigned</span>
            {% else %}
            <span class="text-rose-600 font-semibold uppercase tracking-[0.3em] text-[10px]">Pending</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <form method="post" action="{{ url_for('clear_absence_assignments') }}" class="inline">
              <input type="hidden" name="request_id" value="{{ entry.request_id }}" />
              <input type="hidden" name="date" value="{{ selected_date or '' }}" />
              <button
                type="submit"
                class="rounded-full border border-slate-200 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50"
              >
                Clear covers
              </button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p class="text-sm text-slate-500 text-center">No absences were recorded for {{ selected_date }} yet.</p>
    {% endif %}
  </section>
  {% endif %}
</div>
{% endblock %}

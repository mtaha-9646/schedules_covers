{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
  <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow">
    <div class="flex flex-wrap items-start justify-between gap-3">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Leave covers</p>
        <h1 class="text-2xl font-semibold text-slate-900">Track incoming absences</h1>
        <p class="text-sm text-slate-500">Monitor approvals, replay the webhook, and view payloads for downstream systems.</p>
      </div>
      <a href="{{ url_for('covers_assignments') }}" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50">View assignments</a>
    </div>
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow space-y-4">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Recorded leave requests</p>
        <h2 class="text-xl font-semibold text-slate-900">Latest incoming records</h2>
      </div>
      <div id="covers-list" class="space-y-3 text-sm text-slate-600">Loading...</div>
    </div>
    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow space-y-4">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Manual webhook test</p>
        <h2 class="text-xl font-semibold text-slate-900">Send a mock payload</h2>
      </div>
      <form id="covers-form" class="grid gap-3 text-sm">
        <input name="request_id" placeholder="request id" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="teacher" placeholder="Teacher name" required class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="leave_type" placeholder="Leave type" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="leave_date" type="date" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="status" placeholder="Status" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="reason" placeholder="Reason" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <input name="secret" placeholder="Optional webhook secret" class="w-full rounded-2xl border border-slate-200 px-4 py-2" />
        <button type="submit" class="rounded-2xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800">Send test request</button>
      </form>
      <div id="webhook-response" class="text-sm text-slate-600"></div>
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
        <div class="flex items-center justify-between text-xs uppercase tracking-[0.3em] text-slate-500">
          <span>Payload ready</span>
          <button id="copy-request-button" class="font-semibold text-slate-700">Copy</button>
        </div>
        <pre id="request-payload" class="mt-2 h-32 overflow-auto text-xs text-slate-600"></pre>
      </div>
    </div>
  </section>
</div>

<script>
  const coversList = document.querySelector("#covers-list");
  const responsePanel = document.querySelector("#webhook-response");
  const payloadDisplay = document.querySelector("#request-payload");
  const copyButton = document.querySelector("#copy-request-button");

  const escapeHTML = (str) => String(str || "").replace(/[&<>"']/g, (ch) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[ch]);

  const renderCovers = async () => {
    coversList.innerHTML = "<p class='text-sm text-slate-500'>Loading...</p>";
    try {
      const response = await fetch("/api/covers");
      if (!response.ok) throw new Error("Unable to load covers");
      const data = await response.json();
      const entries = Object.entries(data).sort(([a], [b]) => a.localeCompare(b));
      if (!entries.length) {
        coversList.innerHTML = "<p class='text-sm text-slate-500'>No cover records yet.</p>";
        return;
      }
      coversList.innerHTML = entries.map(([date, rows]) => `
        <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
          <div class="flex items-center justify-between text-sm text-slate-700">
            <strong>${escapeHTML(date)}</strong>
            <span>${rows.length} request(s)</span>
          </div>
          <div class="mt-3 space-y-2 text-xs text-slate-600">
            ${rows.map((row) => `
              <div class="grid grid-cols-[1fr_auto] gap-2">
                <div>
                  <p class="font-semibold">${escapeHTML(row.teacher)}</p>
                  <p class="text-xs text-slate-500">${escapeHTML(row.leave_type || "")} &middot; ${escapeHTML(row.status || "")}</p>
                </div>
                <div class="text-right text-[11px] uppercase tracking-[0.3em] text-slate-500">${escapeHTML(row.request_id)}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `).join("");
    } catch (error) {
      coversList.innerHTML = `<p class='text-sm text-red-500'>${error.message}</p>`;
    }
  };

  document.querySelector("#covers-form").addEventListener("submit", async (event) => {
    event.preventDefault();
    const formData = new FormData(event.target);
    const payload = {
      request_id: formData.get("request_id") || `manual-${Date.now()}`,
      teacher: formData.get("teacher"),
      leave_type: formData.get("leave_type") || "planned",
      leave_date: formData.get("leave_date") || new Date().toISOString().slice(0, 10),
      status: formData.get("status") || "pending",
      reason: formData.get("reason"),
      submitted_at: new Date().toISOString(),
    };
    payloadDisplay.textContent = JSON.stringify(payload, null, 2);
    const headers = { "Content-Type": "application/json" };
    const secret = formData.get("secret");
    if (secret) headers["X-Leave-Webhook-Secret"] = secret;
    responsePanel.textContent = "Sending...";
    try {
      const response = await fetch("/external/leave-approvals", {
        method: "POST",
        headers,
        body: JSON.stringify(payload),
      });
      const body = await response.json().catch(() => ({}));
      if (response.ok) {
        responsePanel.innerHTML = `<p class='text-sm text-emerald-500'>Success: ${escapeHTML(body.status || "recorded")}</p>`;
        await renderCovers();
      } else {
        responsePanel.innerHTML = `<p class='text-sm text-red-500'>Error ${response.status}: ${escapeHTML(body.error || "unexpected")}</p>`;
      }
    } catch (error) {
      responsePanel.innerHTML = `<p class='text-sm text-red-500'>${error.message}</p>`;
    }
  });

  copyButton.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(payloadDisplay.textContent);
      copyButton.textContent = "Copied"
    } catch {
      copyButton.textContent = "Copy failed";
    }
    setTimeout(() => (copyButton.textContent = "Copy"), 1200);
  });

  renderCovers();
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="space-y-6">
  <section class="grid gap-6 rounded-3xl border border-slate-200 bg-white p-6 shadow">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Teacher schedules</p>
      <h1 class="text-3xl font-semibold text-slate-900">Real-time visibility across departments</h1>
      <p class="mt-2 text-slate-500">
        Cards below surface total courses, grade coverage, and how regularly each teacher is scheduled. Combine the search and filters with the availability checker for a fast response.
      </p>
    </div>
    <div class="grid gap-4 sm:grid-cols-4">
      <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
        <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">Total</p>
        <p class="text-2xl font-semibold text-slate-900">{{ stats.total_teachers }}</p>
        <p class="text-sm text-slate-500">Teachers in roster</p>
      </div>
      <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
        <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">Middle</p>
        <p class="text-2xl font-semibold text-slate-900">{{ stats.middle }}</p>
        <p class="text-sm text-slate-500">Middle school</p>
      </div>
      <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
        <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">High</p>
        <p class="text-2xl font-semibold text-slate-900">{{ stats.high }}</p>
        <p class="text-sm text-slate-500">High school</p>
      </div>
      <div class="rounded-2xl border border-slate-100 bg-slate-50 p-4">
        <p class="text-[11px] uppercase tracking-[0.3em] text-slate-500">General</p>
        <p class="text-2xl font-semibold text-slate-900">{{ stats.general }}</p>
        <p class="text-sm text-slate-500">Support / floating</p>
      </div>
    </div>
  </section>

  <section class="grid gap-6 rounded-3xl border border-slate-200 bg-white p-6 shadow md:grid-cols-[2fr_1fr]">
    <div>
      <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Availability checker</p>
      <h2 class="mt-1 text-2xl font-semibold text-slate-900">Live period readiness</h2>
      <p class="text-sm text-slate-500">Click run to inspect who is free versus booked for any period.</p>
    </div>
    <form id="availability-form" class="grid gap-3" onsubmit="return false;">
      <label class="text-xs uppercase tracking-[0.3em] text-slate-500">Day</label>
      <select id="day-select" class="rounded-2xl border border-slate-200 px-4 py-2 text-sm">
        {% for code, label in days.items() %}
        <option value="{{ code }}">{{ label }}</option>
        {% endfor %}
      </select>
      <label class="text-xs uppercase tracking-[0.3em] text-slate-500">Period</label>
      <select id="period-select" class="rounded-2xl border border-slate-200 px-4 py-2 text-sm">
        {% for period in period_options %}
        <option value="{{ period }}">{{ period }}</option>
        {% endfor %}
      </select>
      <button id="check-availability" type="button" class="rounded-2xl bg-emerald-500 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-400">Run availability</button>
    </form>
    <div id="availability-result" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-600">
      Select a day and period, then run the availability check.
    </div>
  </section>

  <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow">
    <div class="flex flex-wrap items-center justify-between gap-3">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Roster filters</p>
        <h2 class="text-xl font-semibold text-slate-900">Find teachers quickly</h2>
      </div>
      <a href="{{ url_for('print_all') }}" class="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-slate-600 hover:bg-slate-50">Print all schedules</a>
    </div>
    <div class="mt-4 flex flex-wrap gap-3">
      <input id="teacher-search" type="text" placeholder="Search by name" class="flex-1 min-w-[200px] rounded-2xl border border-slate-200 px-4 py-2 text-sm" />
      <select id="type-filter" class="rounded-2xl border border-slate-200 px-4 py-2 text-sm">
        <option value="all">All teachers</option>
        <option value="Middle School">Middle School</option>
        <option value="High School">High School</option>
        <option value="Middle & High School">Middle & High School</option>
        <option value="General">General</option>
      </select>
    </div>
  </section>

  <section class="grid gap-4 md:grid-cols-2 lg:grid-cols-3" id="teacher-grid">
    {% for teacher in teachers %}
    <article class="flex h-full flex-col justify-between gap-3 rounded-3xl border border-slate-200 bg-white p-5 shadow transition hover:-translate-y-1 hover:shadow-lg" data-teacher-type="{{ teacher.level_label }}" data-teacher-name="{{ teacher.name | lower }}">
      <div>
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-lg font-semibold text-slate-900">
            <a href="{{ url_for('teacher_detail', slug=teacher.slug) }}" class="hover:text-slate-700">{{ teacher.name }}</a>
          </h3>
          <span class="rounded-full border border-slate-200 px-3 py-1 text-[11px] uppercase tracking-[0.3em] text-slate-500">{{ teacher.primary_class }}</span>
        </div>
        <p class="text-sm text-slate-500">{{ teacher.subject }}</p>
      </div>
      <p class="text-sm text-slate-500">{{ teacher.level_label }} &middot; {{ teacher.day_count }} day(s) &middot; {{ teacher.course_total }} courses</p>
      <a class="text-sm font-semibold text-emerald-600 hover:text-emerald-500" href="{{ url_for('teacher_detail', slug=teacher.slug) }}">View schedule ?</a>
    </article>
    {% endfor %}
  </section>
</div>

<script>
  const searchInput = document.querySelector("#teacher-search");
  const typeFilter = document.querySelector("#type-filter");
  const cards = document.querySelectorAll("[data-teacher-name]");

  const filterCards = () => {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedType = typeFilter.value;
    cards.forEach((card) => {
      const matchesTerm = card.dataset.teacherName.includes(searchTerm);
      const matchesType = selectedType === "all" || card.dataset.teacherType === selectedType;
      card.style.display = matchesTerm && matchesType ? "grid" : "none";
    });
  };

  searchInput.addEventListener("input", filterCards);
  typeFilter.addEventListener("change", filterCards);

  const availabilityResult = document.querySelector("#availability-result");
  document.querySelector("#check-availability").addEventListener("click", async () => {
    const day = document.querySelector("#day-select").value;
    const period = document.querySelector("#period-select").value;
    availabilityResult.textContent = "Looking up availability...";
    try {
      const response = await fetch(`/api/availability?day=${encodeURIComponent(day)}&period=${encodeURIComponent(period)}`);
      const payload = await response.json();
      if (!response.ok) throw new Error(payload.error || "Unable to fetch availability");
      const available = payload.available || [];
      const occupied = payload.occupied || [];
      availabilityResult.innerHTML = `
        <p class="text-sm font-semibold text-emerald-600">${available.length} free &middot; ${occupied.length} booked &middot; ${payload.period}</p>
        <div class="mt-3 space-y-2 text-sm text-slate-600">
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Available</p>
          <p>${available.map((t) => `${t.name} &middot; ${t.level_label}`).join(" &middot; ") || "None"}</p>
          <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Occupied</p>
          <p>${occupied.map((o) => `${o.name} &middot; ${o.subject}`).join(" &middot; ") || "None"}</p>
        </div>
      `;
    } catch (error) {
      availabilityResult.innerHTML = `<p class="text-sm text-red-500">${error.message}</p>`;
    }
  });
</script>
{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Suspension</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      .custom-dropdown-list { max-height: 200px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 0.375rem; background-color: white; position: absolute; width: 100%; z-index: 10; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); }
      .custom-dropdown-list-item { padding: 0.75rem 1rem; cursor: pointer; }
      .custom-dropdown-list-item:hover { background-color: #eff6ff; }
    </style>
    <script>
        async function lookupStudent() {
            const esis = document.getElementById('esis').value.trim();
            if (!esis) { alert('Enter ESIS first'); return; }
            try {
                const resp = await fetch(`/api/student/by-esis?esis=${encodeURIComponent(esis)}`);
                if (!resp.ok) throw new Error('Not found');
                const s = await resp.json();
                document.getElementById('student_name').value = s.name || '';
                const hrSelect = document.getElementById('grade_class_display');
                if (hrSelect && s.homeroom) {
                    // If the homeroom exists as an option, select it; else set as custom value
                    let matched = false;
                    for (const opt of hrSelect.options) {
                        if (opt.value === s.homeroom) { opt.selected = true; matched = true; break; }
                    }
                    if (!matched) {
                        const opt = document.createElement('option');
                        opt.value = s.homeroom; opt.textContent = s.homeroom; opt.selected = true;
                        hrSelect.appendChild(opt);
                    }
                    document.getElementById('grade_class').value = s.homeroom;
                }
            } catch (e) {
                alert('Student not found by ESIS');
            }
        }
    </script>
    
    <script>
        function confirmSubmit(e) {
            const requiredIds = ['esis','student_name','grade_class','date_of_suspension','duration','reason','incident_details','behavior_plan','assigned_staff','reintegration_plan','notes'];
            for (const id of requiredIds) {
                const el = document.getElementById(id);
                const val = (el && (el.value || '').trim()) || '';
                if (!val) { e.preventDefault(); alert('Please fill all required fields.'); return false; }
            }
            const pc = document.querySelector('input[name="parent_contacted"]');
            const pm = document.querySelector('input[name="parent_meeting"]');
            if (!pc.checked || !pm.checked) { e.preventDefault(); alert('Please confirm parent contacted and meeting.'); return false; }
            return true;
        }
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const esisLookup = document.getElementById('esis_lookup');
        const nameSearchInput = document.getElementById('name_search_input');
        const nameSearchResults = document.getElementById('name_search_results');
        const gradeSelect = document.getElementById('grade_select');
        const homeroomSelect = document.getElementById('homeroom_select');
        const studentSelect = document.getElementById('student_select');

        const hiddenEsis = document.getElementById('esis');
        const hiddenName = document.getElementById('student_name');
        const hiddenClass = document.getElementById('grade_class');
        const classDisplay = document.getElementById('grade_class_display');

        const setStudent = (esis, name, homeroom) => {
          hiddenEsis.value = esis || '';
          hiddenName.value = name || '';
          hiddenClass.value = homeroom || '';
          classDisplay.value = homeroom || '';
          studentSelect.innerHTML = `<option value="${esis}" selected>${name}</option>`;
          studentSelect.disabled = false;
        };

        esisLookup.addEventListener('blur', async () => {
          const esis = esisLookup.value.trim();
          if (!esis) return;
          try {
            const resp = await fetch(`/api/student/by-esis?esis=${encodeURIComponent(esis)}`);
            if (!resp.ok) throw new Error('not found');
            const s = await resp.json();
            setStudent(s.esis, s.name, s.homeroom);
          } catch(e) { alert('Student not found by ESIS'); }
        });

        gradeSelect.addEventListener('change', async () => {
          const grade = gradeSelect.value;
          homeroomSelect.innerHTML = '<option value="">Loading...</option>';
          homeroomSelect.disabled = true;
          studentSelect.innerHTML = '<option value="">Select Student</option>';
          studentSelect.disabled = true;
          if (!grade) { homeroomSelect.innerHTML = '<option value="">Select Homeroom</option>'; return; }
          try {
            const r = await fetch(`/api/homerooms/by-grade?grade=${encodeURIComponent(grade)}`);
            const list = await r.json();
            homeroomSelect.innerHTML = '<option value="">Select Homeroom</option>';
            list.forEach(hr => { homeroomSelect.innerHTML += `<option value="${hr}">${hr}</option>`; });
            homeroomSelect.disabled = false;
          } catch(e) { console.error(e); }
        });

        homeroomSelect.addEventListener('change', async () => {
          const hr = homeroomSelect.value;
          studentSelect.innerHTML = '<option value="">Loading...</option>';
          studentSelect.disabled = true;
          if (!hr) { studentSelect.innerHTML = '<option value="">Select Student</option>'; return; }
          try {
            const r = await fetch(`/api/students/by-homeroom?homeroom=${encodeURIComponent(hr)}`);
            const list = await r.json();
            studentSelect.innerHTML = '<option value="">Select Student</option>';
            list.forEach(s => { studentSelect.innerHTML += `<option value="${s.esis}">${s.name} (${s.esis})</option>`; });
            studentSelect.disabled = false;
          } catch(e) { console.error(e); }
        });

        studentSelect.addEventListener('change', () => {
          const opt = studentSelect.options[studentSelect.selectedIndex];
          if (!opt || !opt.value) return;
          const esis = opt.value;
          const name = opt.textContent.split(' (')[0];
          const hr = homeroomSelect.value || classDisplay.value || '';
          setStudent(esis, name, hr);
        });

        let timer;
        nameSearchInput.addEventListener('input', () => {
          const q = nameSearchInput.value.trim();
          clearTimeout(timer);
          if (q.length < 2) { nameSearchResults.classList.add('hidden'); nameSearchResults.innerHTML = ''; return; }
          timer = setTimeout(async () => {
            try {
              const resp = await fetch(`/api/students/search?q=${encodeURIComponent(q)}`);
              const list = await resp.json();
              if (!Array.isArray(list) || list.length === 0) { nameSearchResults.classList.add('hidden'); nameSearchResults.innerHTML = ''; return; }
              nameSearchResults.innerHTML = list.map(s => `<div class=\"custom-dropdown-list-item\" data-esis=\"${s.esis}\" data-name=\"${s.name}\" data-homeroom=\"${s.homeroom || ''}\">${s.name} (${s.esis}) â€” ${s.homeroom || ''}</div>`).join('');
              nameSearchResults.classList.remove('hidden');
            } catch(e) { console.error(e); }
          }, 250);
        });

        nameSearchResults.addEventListener('click', (e) => {
          const item = e.target.closest('.custom-dropdown-list-item');
          if (!item) return;
          setStudent(item.dataset.esis, item.dataset.name, item.dataset.homeroom);
          nameSearchResults.classList.add('hidden');
          nameSearchInput.value = `${item.dataset.name} (${item.dataset.esis})`;
        });
      });
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Add Suspension</h1>
            <a href="{{ url_for('behaviour_bp.behaviour_dashboard') }}#tab=suspensions" class="text-blue-600 hover:underline">Back to Dashboard</a>
        </div>

        <form action="{{ url_for('behaviour_bp.add_suspension') }}" method="POST" onsubmit="return confirmSubmit(event)" class="bg-white p-6 rounded-xl shadow">
            <fieldset class="mb-6 border-b border-gray-200 pb-4">
                <legend class="text-lg font-semibold text-gray-800 mb-4">Student Information</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="esis_lookup" class="block text-sm font-medium text-gray-700 mb-1">Search by ESIS</label>
                        <input type="text" id="esis_lookup" class="mt-1 block w-full px-3 py-2 rounded-lg border border-gray-300" placeholder="Enter ESIS to auto-fill" />
                    </div>
                    <div>
                        <label for="name_search_input" class="block text-sm font-medium text-gray-700 mb-1">Search by Name or ESIS</label>
                        <div class="relative">
                            <input type="text" id="name_search_input" class="mt-1 block w-full px-3 py-2 rounded-lg border border-gray-300" placeholder="Type at least 2 characters" />
                            <div id="name_search_results" class="hidden custom-dropdown-list"></div>
                        </div>
                    </div>
                    <div>
                        <label for="grade_select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Grade</label>
                        <select id="grade_select" class="mt-1 block w-full px-3 py-2 rounded-lg border border-gray-300">
                            <option value="">Select Grade</option>
                            {% for g in grades %}<option value="{{ g }}">G{{ g }}</option>{% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="homeroom_select" class="block text-sm font-medium text-gray-700 mb-1">Filter by Homeroom</label>
                        <select id="homeroom_select" class="mt-1 block w-full px-3 py-2 rounded-lg border border-gray-300" disabled>
                            <option value="">Select Homeroom</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="student_select" class="block text-sm font-medium text-gray-700 mb-1">Select Student</label>
                        <select id="student_select" class="mt-1 block w-full px-3 py-2 rounded-lg border border-gray-300" disabled>
                            <option value="">Select Student</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" id="esis" name="esis" />
                <input type="hidden" id="student_name" name="student_name" />
                <input type="hidden" id="grade_class" name="grade_class" />
            </fieldset>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="grade_class_display" class="block text-sm font-medium text-gray-700">Grade/Class *</label>
                    <input id="grade_class_display" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300 bg-gray-100" disabled />
                </div>
                <div>
                    <label for="date_of_suspension" class="block text-sm font-medium text-gray-700">Date of Suspension *</label>
                    <input type="date" id="date_of_suspension" name="date_of_suspension" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required>
                </div>

                <div>
                    <label for="duration" class="block text-sm font-medium text-gray-700">Duration *</label>
                    <input type="text" id="duration" name="duration" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" placeholder="e.g. 3 days" required>
                </div>
                <div>
                    <label for="assigned_staff" class="block text-sm font-medium text-gray-700">Assigned Counselor/Teacher *</label>
                    <input type="text" id="assigned_staff" name="assigned_staff" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" placeholder="e.g. Mr. Ali" required>
                </div>

                <div class="md:col-span-2">
                    <label for="reason" class="block text-sm font-medium text-gray-700">Reason for Suspension *</label>
                    <textarea id="reason" name="reason" rows="2" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="incident_details" class="block text-sm font-medium text-gray-700">Incident Details *</label>
                    <textarea id="incident_details" name="incident_details" rows="3" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required></textarea>
                </div>

                <div class="md:col-span-2 flex items-center gap-6">
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="parent_contacted" class="mr-2" required> Parent/Guardian Contacted
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" name="parent_meeting" class="mr-2" required> Meeting with Parent/Guardian
                    </label>
                </div>

                <div class="md:col-span-2">
                    <label for="behavior_plan" class="block text-sm font-medium text-gray-700">Behavior Plan *</label>
                    <textarea id="behavior_plan" name="behavior_plan" rows="2" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="reintegration_plan" class="block text-sm font-medium text-gray-700">Reintegration Plan *</label>
                    <textarea id="reintegration_plan" name="reintegration_plan" rows="2" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="notes" class="block text-sm font-medium text-gray-700">Notes / Comments *</label>
                    <textarea id="notes" name="notes" rows="2" class="mt-1 w-full px-3 py-2 rounded-lg border border-gray-300" required></textarea>
                </div>
            </div>

            <div class="mt-6 flex items-center gap-3">
                <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">Save</button>
                <a href="{{ url_for('behaviour_bp.behaviour_dashboard') }}#tab=suspensions" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">Cancel</a>
            </div>
        </form>
    </div>
</body>
</html>

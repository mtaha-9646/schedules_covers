<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ form.name }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="flex flex-wrap items-center justify-between mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-800">{{ form.name }}</h1>
        <p class="text-sm text-gray-500 mt-1">Complete the student lookup first, then capture responses below.</p>
      </div>
      <div class="flex items-center gap-3">
        <a href="{{ url_for('behaviour_bp.behaviour_dashboard') }}" class="px-4 py-2 bg-slate-600 text-white rounded-lg">Back to Dashboard</a>
      </div>
    </header>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
      <div class="space-y-3 mb-6">
        {% for category, message in messages %}
          {% if category in ['success', 'ok'] %}
          <div class="px-4 py-3 bg-emerald-50 border border-emerald-200 text-emerald-700 rounded-lg">{{ message }}</div>
          {% elif category in ['warning'] %}
          <div class="px-4 py-3 bg-amber-50 border border-amber-200 text-amber-700 rounded-lg">{{ message }}</div>
          {% elif category in ['error', 'danger'] %}
          <div class="px-4 py-3 bg-red-50 border border-red-200 text-red-700 rounded-lg">{{ message }}</div>
          {% else %}
          <div class="px-4 py-3 bg-slate-50 border border-slate-200 text-slate-700 rounded-lg">{{ message }}</div>
          {% endif %}
        {% endfor %}
      </div>
      {% endif %}
    {% endwith %}

    <div class="bg-white p-6 rounded-xl shadow">
      <form method="POST" enctype="multipart/form-data" id="dynamic_form">
        <fieldset class="mb-8 border border-slate-200 rounded-xl p-4">
          <legend class="px-2 text-lg font-semibold text-gray-800">Student Selection</legend>

          <div id="df_student_alert" class="hidden mt-3 px-3 py-2 rounded-lg text-sm"></div>

          <input type="hidden" id="student_esis" name="student_esis" value="{{ student_info.esis or '' }}">
          <input type="hidden" id="student_name" name="student_name" value="{{ student_info.name or '' }}">
          <input type="hidden" id="student_homeroom" name="student_homeroom" value="{{ student_info.homeroom or '' }}">

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Search by ESIS</label>
              <div class="flex gap-2">
                <input type="text" id="df_esis_input" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter ESIS (e.g. 12345678)">
                <button type="button" id="df_esis_lookup_btn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg">Lookup</button>
              </div>
            </div>
            <div class="relative">
              <label class="block text-sm font-medium text-gray-700 mb-1">Search by Name or ESIS</label>
              <input type="text" id="df_name_search" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type at least 2 characters">
              <div id="df_name_results" class="hidden absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-20 max-h-64 overflow-y-auto"></div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Grade</label>
              <select id="df_grade_select" name="grade_filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <option value="">Select grade</option>
                {% for grade in grades %}
                  <option value="{{ grade }}" {% if selected_grade == grade %}selected{% endif %}>Grade {{ grade }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Homeroom</label>
              <select id="df_homeroom_select" name="homeroom_filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" {% if not selected_homeroom %}disabled{% endif %}>
                <option value="">{{ 'Select homeroom' if selected_grade else 'Choose grade first' }}</option>
                {% if selected_homeroom %}
                  <option value="{{ selected_homeroom }}" selected>{{ selected_homeroom }}</option>
                {% endif %}
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1">Choose Student</label>
              <select id="df_student_select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" {% if not student_info.esis %}disabled{% endif %}>
                <option value="">{{ 'Select student' if student_info.esis else 'Lookup student first' }}</option>
              </select>
            </div>
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-4">
            <div class="bg-slate-50 px-4 py-2 rounded-lg text-sm text-slate-700" id="df_student_summary">
              {% if student_info.name %}
                {{ student_info.name }} ({{ student_info.esis }}){% if student_info.homeroom %} Â- {{ student_info.homeroom }}{% endif %}
              {% else %}
                No student selected yet.
              {% endif %}
            </div>
            <button type="button" id="df_clear_student" class="text-sm text-slate-500 hover:text-slate-700">Clear Selection</button>
          </div>
        </fieldset>

        <div class="space-y-6">
          {% if prepared_fields %}
            {% for entry in prepared_fields %}
              {% set field = entry.model %}
              {% set field_type = entry.type %}
              {% set config = entry.config %}
              {% set field_key = 'field_' ~ field.id %}
              {% set field_data = form_data.get(field_key, {}) %}
              {% set stored_value = field_data.get('value', '') %}
              {% set stored_selected = field_data.get('selected', []) %}
              <div class="border border-slate-200 rounded-xl p-4 bg-white">
                <div class="flex items-start justify-between gap-4">
                  <div>
                    <label class="text-sm font-semibold text-slate-800 block mb-1">{{ field.label }}</label>
                    {% if config.description %}
                    <p class="text-xs text-slate-500 mb-2">{{ config.description }}</p>
                    {% endif %}
                    <p class="text-xs uppercase tracking-wide text-slate-400">{{ field_type_labels.get(field_type, field_type.replace('_', ' ').title()) }}</p>
                  </div>
                  {% if config.required %}
                  <span class="text-xs font-semibold text-red-500">Required</span>
                  {% endif %}
                </div>

                <div class="mt-4">
                  {% if field_type == 'short_text' %}
                    <input type="text" name="{{ field_key }}" value="{{ stored_value }}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" {% if config.required %}required{% endif %}>
                  {% elif field_type == 'long_text' %}
                    <textarea name="{{ field_key }}" rows="4" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" {% if config.required %}required{% endif %}>{{ stored_value }}</textarea>
                  {% elif field_type == 'single_choice' %}
                    <div class="space-y-2">
                      {% for choice in config.choices %}
                      <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="radio" name="{{ field_key }}" value="{{ choice }}" class="text-indigo-600 focus:ring-indigo-500" {% if stored_value == choice %}checked{% endif %} {% if config.required %}required{% endif %}>
                        <span>{{ choice }}</span>
                      </label>
                      {% endfor %}
                    </div>
                  {% elif field_type == 'multi_choice' %}
                    <div class="space-y-2">
                      {% for choice in config.choices %}
                      <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="checkbox" name="{{ field_key }}" value="{{ choice }}" class="text-indigo-600 focus:ring-indigo-500" {% if choice in stored_selected %}checked{% endif %}>
                        <span>{{ choice }}</span>
                      </label>
                      {% endfor %}
                    </div>
                  {% elif field_type == 'date' %}
                    <input type="date" name="{{ field_key }}" value="{{ stored_value }}" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" {% if config.required %}required{% endif %}>
                  {% elif field_type == 'likert' %}
                    <div class="space-x-4 flex flex-wrap items-center">
                      {% for label in config.scale.labels %}
                      <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="radio" name="{{ field_key }}" value="{{ label }}" class="text-indigo-600 focus:ring-indigo-500" {% if stored_value == label %}checked{% endif %} {% if config.required %}required{% endif %}>
                        <span>{{ label }}</span>
                      </label>
                      {% endfor %}
                    </div>
                  {% elif field_type == 'file_upload' %}
                    <input type="file" name="{{ field_key }}" class="w-full text-sm text-slate-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" {% if config.accept %}accept="{{ config.accept }}"{% endif %} {% if config.required %}required{% endif %}>
                    <p class="text-xs text-slate-500 mt-2">
                      {% if config.file_types and config.file_types|length > 0 %}
                        Allowed: {{ config.file_types | join(', ') }} Â- Max {{ config.max_size_mb }} MB
                      {% else %}
                        Max file size {{ config.max_size_mb }} MB.
                      {% endif %}
                    </p>
                  {% elif field_type == 'boolean' %}
                    <div class="flex gap-4">
                      <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="radio" name="{{ field_key }}" value="true" class="text-indigo-600 focus:ring-indigo-500" {% if stored_value == config.true_label %}checked{% endif %} {% if config.required %}required{% endif %}>
                        <span>{{ config.true_label }}</span>
                      </label>
                      <label class="flex items-center gap-2 text-sm text-slate-700">
                        <input type="radio" name="{{ field_key }}" value="false" class="text-indigo-600 focus:ring-indigo-500" {% if stored_value == config.false_label %}checked{% endif %} {% if config.required %}required{% endif %}>
                        <span>{{ config.false_label }}</span>
                      </label>
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-sm text-slate-500">This form has no questions configured yet.</div>
          {% endif %}
        </div>

        <div class="mt-6 text-right">
          <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const endpoints = {
        byEsis: "{{ url_for('behaviour_bp.search_student_by_esis_api') }}",
        search: "{{ url_for('behaviour_bp.students_search') }}",
        homerooms: "{{ url_for('behaviour_bp.get_homerooms_by_grade_api') }}",
        studentsByHomeroom: "{{ url_for('behaviour_bp.get_students_by_homeroom_api') }}",
      };

      const initialStudent = {{ student_info|tojson|safe }};
      const initialGrade = {{ selected_grade|tojson|safe }};
      const initialHomeroom = {{ selected_homeroom|tojson|safe }};

      const esisInput = document.getElementById('df_esis_input');
      const esisLookupBtn = document.getElementById('df_esis_lookup_btn');
      const nameInput = document.getElementById('df_name_search');
      const nameResults = document.getElementById('df_name_results');
      const gradeSelect = document.getElementById('df_grade_select');
      const homeroomSelect = document.getElementById('df_homeroom_select');
      const studentSelect = document.getElementById('df_student_select');
      const clearBtn = document.getElementById('df_clear_student');
      const summaryBox = document.getElementById('df_student_summary');
      const alertBox = document.getElementById('df_student_alert');
      const studentEsisHidden = document.getElementById('student_esis');
      const studentNameHidden = document.getElementById('student_name');
      const studentHomeroomHidden = document.getElementById('student_homeroom');
      const formEl = document.getElementById('dynamic_form');

      function showAlert(message, type) {
        if (!alertBox) return;
        let classes = 'mt-3 px-3 py-2 rounded-lg text-sm ';
        if (type === 'error') classes += 'bg-red-50 border border-red-200 text-red-700';
        else if (type === 'warning') classes += 'bg-amber-50 border border-amber-200 text-amber-700';
        else classes += 'bg-emerald-50 border border-emerald-200 text-emerald-700';
        alertBox.className = classes;
        alertBox.textContent = message;
        alertBox.classList.remove('hidden');
      }

      function hideAlert() {
        alertBox?.classList.add('hidden');
      }

      function extractGrade(homeroom) {
        if (!homeroom) return '';
        const match = homeroom.match(/G(\d+)/i);
        return match ? match[1] : '';
      }

      function setStudent(student) {
        if (!student || !student.esis) {
          studentEsisHidden.value = '';
          studentNameHidden.value = '';
          studentHomeroomHidden.value = '';
          summaryBox.textContent = 'No student selected yet.';
          return;
        }
        studentEsisHidden.value = student.esis;
        studentNameHidden.value = student.name || '';
        studentHomeroomHidden.value = student.homeroom || '';
        summaryBox.textContent = `${student.name || 'Student'} (${student.esis})${student.homeroom ? ' Â- ' + student.homeroom : ''}`;
      }

      function clearStudent() {
        setStudent(null);
        if (studentSelect) {
          studentSelect.innerHTML = '<option value="">Select student</option>';
          studentSelect.setAttribute('disabled', 'disabled');
        }
      }

      async function lookupByEsis() {
        hideAlert();
        const esis = esisInput.value.trim();
        if (!esis) {
          showAlert('Enter an ESIS to search.', 'warning');
          return;
        }
        try {
          esisLookupBtn.disabled = true;
          esisLookupBtn.textContent = 'Searching...';
          const response = await fetch(`${endpoints.byEsis}?esis=${encodeURIComponent(esis)}`);
          if (response.status === 404) {
            showAlert('No student found for that ESIS.', 'warning');
            clearStudent();
            return;
          }
          if (!response.ok) throw new Error('Lookup failed.');
          const data = await response.json();
          setStudent({
            esis: data.esis,
            name: data.name,
            homeroom: data.homeroom,
          });
          const derivedGrade = extractGrade(data.homeroom);
          if (gradeSelect && derivedGrade) {
            gradeSelect.value = derivedGrade;
            await loadHomerooms(derivedGrade, data.homeroom);
            await loadStudentsByHomeroom(data.homeroom, data.esis);
          }
        } catch (error) {
          console.error(error);
          showAlert('Unable to lookup student. Try again later.', 'error');
        } finally {
          esisLookupBtn.disabled = false;
          esisLookupBtn.textContent = 'Lookup';
        }
      }

      let nameSearchTimer = null;
      function searchByName(query) {
        if (!query || query.length < 2) {
          nameResults.classList.add('hidden');
          nameResults.innerHTML = '';
          return;
        }
        if (nameSearchTimer) window.clearTimeout(nameSearchTimer);
        nameSearchTimer = window.setTimeout(async () => {
          try {
            const response = await fetch(`${endpoints.search}?q=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Search failed');
            const list = await response.json();
            if (!Array.isArray(list) || !list.length) {
              nameResults.innerHTML = '<div class="px-4 py-2 text-sm text-slate-500">No matches</div>';
              nameResults.classList.remove('hidden');
              return;
            }
            nameResults.innerHTML = list.map(student => `
              <button type="button" class="w-full text-left px-4 py-2 hover:bg-indigo-50 flex flex-col" data-esis="${student.esis}" data-name="${student.name}" data-homeroom="${student.homeroom || ''}">
                <span class="font-medium text-slate-800">${student.name}</span>
                <span class="text-xs text-slate-500">${student.esis}${student.homeroom ? ' Â- ' + student.homeroom : ''}</span>
              </button>
            `).join('');
            nameResults.classList.remove('hidden');
          } catch (error) {
            console.error(error);
          }
        }, 250);
      }

      async function loadHomerooms(grade, preselect) {
        if (!grade) {
          homeroomSelect.innerHTML = '<option value="">Choose grade first</option>';
          homeroomSelect.setAttribute('disabled', 'disabled');
          return;
        }
        try {
          const response = await fetch(`${endpoints.homerooms}?grade=${encodeURIComponent(grade)}`);
          if (!response.ok) throw new Error('Failed to load homerooms');
          const homerooms = await response.json();
          homeroomSelect.innerHTML = '<option value="">Select homeroom</option>';
          homerooms.forEach(hr => {
            const option = document.createElement('option');
            option.value = hr;
            option.textContent = hr;
            if (preselect && preselect === hr) option.selected = true;
            homeroomSelect.appendChild(option);
          });
          homeroomSelect.removeAttribute('disabled');
          if (preselect) {
            await loadStudentsByHomeroom(preselect, studentEsisHidden.value);
          } else {
            studentSelect.innerHTML = '<option value="">Select student</option>';
            studentSelect.setAttribute('disabled', 'disabled');
          }
        } catch (error) {
          console.error(error);
          showAlert('Unable to load homerooms for that grade.', 'error');
        }
      }

      async function loadStudentsByHomeroom(homeroom, preselectEsis) {
        if (!homeroom) {
          studentSelect.innerHTML = '<option value="">Select student</option>';
          studentSelect.setAttribute('disabled', 'disabled');
          return;
        }
        try {
          const response = await fetch(`${endpoints.studentsByHomeroom}?homeroom=${encodeURIComponent(homeroom)}`);
          if (!response.ok) throw new Error('Failed to load students');
          const students = await response.json();
          studentSelect.innerHTML = '<option value="">Select student</option>';
          students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.esis;
            option.textContent = `${student.name} (${student.esis})`;
            option.dataset.name = student.name;
            option.dataset.homeroom = student.homeroom || '';
            if (preselectEsis && preselectEsis === student.esis) option.selected = true;
            studentSelect.appendChild(option);
          });
          studentSelect.removeAttribute('disabled');
        } catch (error) {
          console.error(error);
          showAlert('Unable to load students for that homeroom.', 'error');
        }
      }

      esisLookupBtn?.addEventListener('click', lookupByEsis);
      esisInput?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          lookupByEsis();
        }
      });

      nameInput?.addEventListener('input', (e) => searchByName(e.target.value));

      document.addEventListener('click', (e) => {
        if (!nameResults.contains(e.target) && e.target !== nameInput) {
          nameResults.classList.add('hidden');
        }
      });

      nameResults?.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-esis]');
        if (!button) return;
        setStudent({
          esis: button.dataset.esis,
          name: button.dataset.name,
          homeroom: button.dataset.homeroom,
        });
        nameResults.classList.add('hidden');
      });

      gradeSelect?.addEventListener('change', (e) => {
        const grade = e.target.value;
        clearStudent();
        if (grade) {
          loadHomerooms(grade);
        } else {
          homeroomSelect.innerHTML = '<option value="">Choose grade first</option>';
          homeroomSelect.setAttribute('disabled', 'disabled');
        }
      });

      homeroomSelect?.addEventListener('change', (e) => {
        const homeroom = e.target.value;
        clearStudent();
        if (homeroom) {
          loadStudentsByHomeroom(homeroom);
        }
      });

      studentSelect?.addEventListener('change', (e) => {
        const selected = e.target.options[e.target.selectedIndex];
        if (!selected || !selected.value) {
          clearStudent();
          return;
        }
        setStudent({
          esis: selected.value,
          name: selected.dataset.name,
          homeroom: selected.dataset.homeroom,
        });
      });

      clearBtn?.addEventListener('click', () => {
        clearStudent();
        if (studentSelect) {
          studentSelect.value = '';
        }
      });

      formEl?.addEventListener('submit', (e) => {
        if (!studentEsisHidden.value) {
          e.preventDefault();
          showAlert('Please select a student before submitting the form.', 'error');
        }
      });

      if (initialStudent && initialStudent.esis) {
        setStudent(initialStudent);
      }

      if (initialGrade) {
        loadHomerooms(initialGrade, initialHomeroom);
        if (initialHomeroom) {
          const presetEsis = initialStudent && initialStudent.esis ? initialStudent.esis : null;
          loadStudentsByHomeroom(initialHomeroom, presetEsis);
        }
      }
    })();
  </script>
</body>
</html>

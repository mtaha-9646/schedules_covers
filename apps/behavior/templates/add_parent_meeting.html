<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Parent Meeting</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style> body { font-family: 'Inter', sans-serif; } </style>
  <script>
    async function lookupStudent() {
      const esis = document.getElementById('esis').value.trim();
      if (!esis) { alert('Enter ESIS first'); return; }
      try {
        const resp = await fetch(`/api/student/by-esis?esis=${encodeURIComponent(esis)}`);
        if (!resp.ok) throw new Error('not found');
        const s = await resp.json();
        document.getElementById('student_name').value = s.name || '';
        document.getElementById('grade_session').value = s.homeroom || '';
      } catch(e){ alert('Student not found by ESIS'); }
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-gray-800">Parent Meeting</h1>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('behaviour_bp.behaviour_dashboard') }}" class="px-4 py-2 bg-slate-600 text-white text-sm rounded">Back</a>
      </div>
    </header>

    <form method="POST" class="bg-white p-6 rounded-xl shadow grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="text-sm text-gray-700">Parent Name</label>
        <input type="text" name="parent_name" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div></div>

      <div>
        <label class="text-sm text-gray-700">Student Name</label>
        <input type="text" id="student_name" name="student_name" value="{{ (student.name if student else '') }}" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label class="text-sm text-gray-700">eSiS</label>
        <div class="flex gap-2">
          <input type="text" id="esis" name="esis" value="{{ esis }}" class="mt-1 w-full px-3 py-2 border rounded" />
          <button type="button" onclick="lookupStudent()" class="mt-1 px-3 py-2 bg-indigo-600 text-white rounded">Lookup</button>
        </div>
      </div>

      <div>
        <label class="text-sm text-gray-700">Grade/Session</label>
        <input type="text" id="grade_session" name="grade_session" value="{{ (student.homeroom if student else '') }}" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label class="text-sm text-gray-700">Attended by</label>
        <input type="text" name="attended_by" value="{{ (session.get('teacher_name') or '') }} ({{ 'Admin' if session.get('is_admin') or session.get('role')=='admin' else 'Teacher' }})" class="mt-1 w-full px-3 py-2 border rounded bg-gray-50" readonly />
      </div>

      <div>
        <label class="text-sm text-gray-700">Date</label>
        <input type="date" name="date" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>
      <div>
        <label class="text-sm text-gray-700">Time</label>
        <input type="time" name="time" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>

      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Meeting requested by</label>
        <input type="text" name="requested_by" class="mt-1 w-full px-3 py-2 border rounded" />
      </div>

      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Parent Concerns</label>
        <textarea name="parent_concerns" rows="3" class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Teacher/School Concerns</label>
        <textarea name="school_concerns" rows="3" class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>

      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Possible Solutions / Recommendations - Parent</label>
        <textarea name="solutions_parent" rows="3" class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>
      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Possible Solutions / Recommendations - School/Teacher</label>
        <textarea name="solutions_school" rows="3" class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>

      <div class="md:col-span-2">
        <label class="text-sm text-gray-700">Agreed Upon Next Steps</label>
        <textarea name="agreed_next_steps" rows="4" class="mt-1 w-full px-3 py-2 border rounded"></textarea>
      </div>

      <div class="md:col-span-2 border-t pt-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-800">Required Signatures</h2>
          <p class="text-sm text-gray-500">Select the signers for this meeting and capture their signatures now.</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {% for preset in signature_presets %}
          <div class="border rounded-lg p-3 bg-white" data-sig-card data-key="{{ preset.key }}" data-role="{{ preset.role }}" data-label="{{ preset.label }}" data-prefill="{{ preset.prefill_field or '' }}" data-required="{{ 1 if preset.default else 0 }}">
            <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
              <input type="checkbox" class="sig-toggle rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" {% if preset.default %}checked{% endif %}>
              <span>{{ preset.label }}</span>
              <span class="text-[10px] uppercase tracking-wide text-rose-600 font-semibold {% if not preset.default %}hidden{% endif %}" data-required-pill>Required</span>
            </label>
            <div class="mt-3 space-y-2" data-pad-wrapper>
              <div>
                <label class="text-xs text-gray-600">Signer Name</label>
                <input type="text" class="sig-name mt-1 w-full px-2 py-1.5 border rounded text-sm" placeholder="{{ preset.label }}">
              </div>
              <div>
                <canvas class="sig-canvas w-full border rounded bg-white" height="160"></canvas>
                <button type="button" class="sig-clear mt-2 text-xs text-indigo-600">Clear</button>
              </div>
              <p class="text-xs text-gray-500">Use a mouse or touch screen to sign.</p>
            </div>
          </div>
          {% endfor %}
        </div>
        <input type="hidden" name="required_signatures_payload" id="required_signatures_payload" />
      </div>

      <div class="md:col-span-2 flex justify-end gap-2">
        <a href="{{ url_for('behaviour_bp.student_incidents_page', esis=(student.esis if student else esis)) }}" class="px-4 py-2 bg-gray-200 text-gray-800 rounded">Cancel</a>
        <button class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
      </div>
    </form>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.querySelector('form');
      const payloadInput = document.getElementById('required_signatures_payload');
      const cards = Array.from(document.querySelectorAll('[data-sig-card]'));
      const states = [];

      const setupCanvas = (canvas) => {
        const ctx = canvas.getContext('2d');
        const ratio = window.devicePixelRatio || 1;
        const width = canvas.clientWidth;
        const height = canvas.getAttribute('height') || 160;
        canvas.width = Math.floor(width * ratio);
        canvas.height = Math.floor(height * ratio);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#111827';
        ctx.clearRect(0, 0, width, height);
        return ctx;
      };

      cards.forEach(card => {
        const canvas = card.querySelector('.sig-canvas');
        const toggle = card.querySelector('.sig-toggle');
        const nameInput = card.querySelector('.sig-name');
        const clearBtn = card.querySelector('.sig-clear');
        const padWrapper = card.querySelector('[data-pad-wrapper]');
        const required = card.dataset.required === '1';
        const badge = card.querySelector('[data-required-pill]');
        const state = { card, canvas, toggle, nameInput, clearBtn, key: card.dataset.key, role: card.dataset.role, label: card.dataset.label, empty: true, required };
        let ctx = setupCanvas(canvas);
        let drawing = false;
        const pointerPos = (e) => {
          const rect = canvas.getBoundingClientRect();
          return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        };
        const start = (e) => {
          if (canvas.dataset.disabled === '1') return;
          e.preventDefault();
          drawing = true;
          const { x, y } = pointerPos(e);
          ctx.beginPath();
          ctx.moveTo(x, y);
          state.empty = false;
        };
        const move = (e) => {
          if (!drawing || canvas.dataset.disabled === '1') return;
          e.preventDefault();
          const { x, y } = pointerPos(e);
          ctx.lineTo(x, y);
          ctx.stroke();
        };
        const end = () => { drawing = false; };
        canvas.addEventListener('pointerdown', start);
        canvas.addEventListener('pointermove', move);
        window.addEventListener('pointerup', end);
        clearBtn.addEventListener('click', (e) => {
          e.preventDefault();
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          state.empty = true;
        });

        const setEnabled = (enabled) => {
          padWrapper.style.opacity = enabled ? '1' : '0.5';
          canvas.dataset.disabled = enabled ? '0' : '1';
          nameInput.disabled = !enabled;
          clearBtn.disabled = !enabled;
          canvas.style.pointerEvents = enabled ? 'auto' : 'none';
          if (!enabled) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            state.empty = true;
          }
        };
        if (required) {
          toggle.checked = true;
          toggle.disabled = true;
          toggle.classList.add('cursor-not-allowed', 'opacity-60');
          if (badge) badge.classList.remove('hidden');
        }
        setEnabled(required || toggle.checked);
        if (!required) {
          toggle.addEventListener('change', () => setEnabled(toggle.checked));
        }
        toggle.dataset.required = required ? '1' : '0';

        const prefillField = card.dataset.prefill;
        if (prefillField) {
          const src = form.querySelector(`[name=\"${prefillField}\"]`);
          if (src) {
            if (!nameInput.value) nameInput.value = src.value;
            src.addEventListener('input', () => {
              if (!nameInput.value.trim()) nameInput.value = src.value;
            });
          }
        }

        state.toDataURL = () => {
          const tmp = document.createElement('canvas');
          tmp.width = canvas.width;
          tmp.height = canvas.height;
          const tmpCtx = tmp.getContext('2d');
          tmpCtx.drawImage(canvas, 0, 0);
          return tmp.toDataURL('image/png');
        };
        state.resize = () => { ctx = setupCanvas(canvas); state.empty = true; };
        states.push(state);
      });

      window.addEventListener('resize', () => states.forEach(s => s.resize()));

      form.addEventListener('submit', (e) => {
        const payload = [];
        const requiredKeys = states.filter(s => s.required).map(s => s.key);
        for (const state of states) {
          const shouldInclude = state.required || state.toggle.checked;
          if (!shouldInclude) continue;
          const name = state.nameInput.value.trim();
          if (!name) {
            e.preventDefault();
            alert(`Enter the signer name for ${state.label}.`);
            state.nameInput.focus();
            return;
          }
          if (state.empty) {
            e.preventDefault();
            alert(`Capture the signature for ${state.label}.`);
            return;
          }
          payload.push({ key: state.key, signer_name: name, image_data: state.toDataURL() });
        }
        if (payload.length === 0) {
          e.preventDefault();
          alert('Capture at least one signature before saving.');
          return;
        }
        const providedKeys = payload.map(entry => entry.key);
        const missing = requiredKeys.filter(key => !providedKeys.includes(key));
        if (missing.length > 0) {
          e.preventDefault();
          alert('Capture all required signatures before saving.');
          return;
        }
        payloadInput.value = JSON.stringify(payload);
      });
    });
  </script>
</body>
</html>

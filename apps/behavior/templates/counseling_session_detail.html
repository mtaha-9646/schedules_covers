<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Counselling Session Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background: #f7fafc; }
    .report-container { max-width: 960px; margin: 1rem auto; background: #fff; padding: 1.25rem 1.5rem; border-radius: 0.75rem; box-shadow: 0 10px 25px -15px rgba(30,41,59,0.4); }
    .no-print { display: block; }
    @page { size: A4 portrait; margin: 12mm; }
    @media print { body { background: #fff; } .report-container { box-shadow: none; margin: 0; border-radius: 0; } .no-print { display: none !important; } .grid, .flex, .section { page-break-inside: avoid; break-inside: avoid; }
      .checkbox-grid input { accent-color: #2563eb; }
    }
    .section-title { font-size: 1.1rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; }
    .field-label { font-weight: 600; color: #374151; font-size: 0.9rem; }
    .field-value { margin-top: 0.1rem; color: #111827; }
    .checkbox-grid { display: grid; gap: 0.4rem; font-size: 0.9rem; }
    .checkbox-grid label { display: flex; gap: 0.5rem; align-items: flex-start; color: #374151; }
    .checkbox-grid input { margin-top: 0.2rem; accent-color: #2563eb; }
  </style>
</head>
<body>
  <div class="report-container">
    <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
      <div class="flex items-center gap-4">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="School Logo" class="h-12 w-auto" />
        <div>
          <h1 class="text-2xl font-bold text-gray-800">Counselling Session Tracker</h1>
          <p class="text-sm text-gray-500">Documented support for {{ session.student_name }} ({{ session.esis }})</p>
        </div>
      </div>
      <div class="no-print flex flex-wrap gap-2">
        <button id="open-sign-modal" class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700">Add Signature</button>
        <button onclick="window.print()" class="px-4 py-2 bg-emerald-600 text-white text-sm rounded-lg hover:bg-emerald-700">Print</button>
        <a href="{{ url_for('behaviour_bp.student_incidents_page', esis=session.esis) }}" class="px-4 py-2 bg-slate-600 text-white text-sm rounded-lg hover:bg-slate-700">Back to Student</a>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 border border-slate-200 rounded-lg p-4 mb-5">
      <div>
        <p class="field-label">Student Name</p>
        <p class="field-value">{{ session.student_name }}</p>
      </div>
      <div>
        <p class="field-label">eSiS</p>
        <p class="field-value">{{ session.esis }}</p>
      </div>
      <div>
        <p class="field-label">Class &amp; Session</p>
        <p class="field-value">{{ session.homeroom or '-' }}</p>
      </div>
      <div>
        <p class="field-label">Session Date</p>
        <p class="field-value">{{ session.session_date.strftime('%Y-%m-%d') }}</p>
      </div>
      <div>
        <p class="field-label">Duration</p>
        <p class="field-value">{{ session.duration_minutes if session.duration_minutes is not none else '-' }} minutes</p>
      </div>
      <div>
        <p class="field-label">Counselor(s)</p>
        <p class="field-value">{{ session.counselors or '-' }}</p>
      </div>
    </div>

    <div class="section mb-6">
      <p class="section-title">Individual Counseling Sessions Focus</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Academic Counseling &amp; Personal Development</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_study_skills else '' }}> <span>Study skills development</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_time_management else '' }}> <span>Time management strategies</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_academic_goal_setting else '' }}> <span>Academic goal setting</span></label>
          </div>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Social-Emotional &amp; Crisis Counseling</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_self_esteem else '' }}> <span>Self-esteem building</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_decision_making else '' }}> <span>Decision-making skills</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_mindfulness_relaxation else '' }}> <span>Mindfulness and relaxation techniques</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_stress_management else '' }}> <span>Stress management techniques</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_coping_anxiety else '' }}> <span>Coping strategies for anxiety and depression</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_conflict_resolution else '' }}> <span>Conflict resolution skills</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_immediate_crisis_support else '' }}> <span>Immediate support for personal crises</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_grief_loss else '' }}> <span>Grief and loss counseling</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_support_trauma else '' }}> <span>Support for trauma or abuse</span></label>
          </div>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Behavioral Counseling</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_managing_anger else '' }}> <span>Managing anger and frustration</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_improving_communication else '' }}> <span>Improving communication skills</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.focus_positive_habits else '' }}> <span>Developing positive habits</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="section mb-6">
      <p class="section-title">Group Counseling Sessions</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Social Skills &amp; Support Groups</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.group_building_friendships else '' }}> <span>Building friendships and social interactions</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_developing_empathy else '' }}> <span>Developing empathy and cooperation</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_grief_loss_support else '' }}> <span>Grief and loss support</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_anxiety_depression_support else '' }}> <span>Groups for students with anxiety or depression</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_learning_disabilities_support else '' }}> <span>Support for students with learning disabilities</span></label>
          </div>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Stress Relief, Mindfulness &amp; Leadership</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.group_stress_management else '' }}> <span>Stress management techniques</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_leadership_training else '' }}> <span>Leadership skills training</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_team_building else '' }}> <span>Team-building activities</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_community_service else '' }}> <span>Community service projects</span></label>
          </div>
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-700 mb-2">Conflict Resolution Workshops</p>
          <div class="checkbox-grid">
            <label><input type="checkbox" disabled {{ 'checked' if session.group_mediation_skills else '' }}> <span>Mediation skills training</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_role_play_conflict else '' }}> <span>Role-playing conflict scenarios</span></label>
            <label><input type="checkbox" disabled {{ 'checked' if session.group_communication_strategies else '' }}> <span>Communication strategies for resolving disagreements</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="section mb-6">
      <p class="section-title">Summary of Progress</p>
      <p class="field-label mb-1">Individual / Group Dynamics and Observations</p>
      <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.summary_of_progress or '-' }}</p>
    </div>

    <div class="section mb-6">
      <p class="section-title">Progress Toward Goals &amp; Next Steps</p>
      <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.progress_toward_goals or '-' }}</p>
    </div>

    <div class="section mb-6">
      <p class="section-title">Follow Up</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p class="field-label mb-1">Challenges Encountered</p>
          <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.follow_up_challenges or '-' }}</p>
        </div>
        <div>
          <p class="field-label mb-1">Support Provided</p>
          <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.follow_up_support or '-' }}</p>
        </div>
      </div>
    </div>

    <div class="section mb-6">
      <p class="section-title">Next Steps &amp; Recommendations</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <p class="field-label mb-1">Future Sessions Planned</p>
          <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.future_sessions_planned or '-' }}</p>
        </div>
        <div>
          <p class="field-label mb-1">Additional Support Needed</p>
          <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.additional_support_needed or '-' }}</p>
        </div>
        <div>
          <p class="field-label mb-1">Parent / Guardian Communication</p>
          <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.parent_guardian_communication or '-' }}</p>
        </div>
      </div>
    </div>

    <div class="section mb-6">
      <p class="section-title">Counselor's Reflection</p>
      <p class="whitespace-pre-wrap text-sm text-gray-700 bg-slate-50 border border-slate-200 rounded-md p-3">{{ session.counselor_observations or '-' }}</p>
    </div>

    <div class="section">
      <p class="section-title">Signatures</p>
      {% if signatures %}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        {% for sig in signatures %}
        <div class="border border-slate-200 rounded-lg p-3 bg-white">
          <p class="text-sm text-gray-600 mb-1">{{ sig.signer_role }} - <span class="font-semibold text-gray-800">{{ sig.signer_name }}</span></p>
          <div class="bg-white border border-slate-200 rounded-md overflow-hidden flex items-center justify-center h-24">
            <img src="{{ sig.image_data if sig.image_data.startswith('data:') else 'data:image/png;base64,' + sig.image_data }}" alt="Signature" class="max-h-24" />
          </div>
          <p class="text-xs text-gray-400 mt-1">Signed {{ sig.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-sm text-gray-500">No signatures captured yet.</p>
      {% endif %}
    </div>
  </div>

  <div id="signature-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl p-6 relative">
      <button id="close-sign-modal" class="absolute top-3 right-3 text-slate-500 hover:text-slate-700">&times;</button>
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Add Signature</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="text-sm text-gray-700">Signer Name</label>
          <input type="text" id="sig-name" class="mt-1 w-full px-3 py-2 border rounded" placeholder="Full name" />
        </div>
        <div>
          <label class="text-sm text-gray-700">Role</label>
          <select id="sig-role" class="mt-1 w-full px-3 py-2 border rounded">
            <option value="Counselor">Counselor</option>
            <option value="Parent/Guardian">Parent/Guardian</option>
            <option value="Student">Student</option>
            <option value="Administrator">Administrator</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>
      <div>
        <label class="text-sm text-gray-700">Signature</label>
        <canvas id="sig-canvas" class="mt-1 w-full border rounded signature-canvas bg-white" height="200"></canvas>
      </div>
      <div class="flex justify-between items-center mt-3">
        <button id="sig-clear" class="px-4 py-2 bg-gray-200 text-gray-700 rounded">Clear</button>
        <button id="sig-save" class="px-4 py-2 bg-indigo-600 text-white rounded">Save Signature</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const modal = document.getElementById('signature-modal');
      const openBtn = document.getElementById('open-sign-modal');
      const closeBtn = document.getElementById('close-sign-modal');
      const canvas = document.getElementById('sig-canvas');
      const clearBtn = document.getElementById('sig-clear');
      const saveBtn = document.getElementById('sig-save');
      const nameEl = document.getElementById('sig-name');
      const roleEl = document.getElementById('sig-role');
      let ctx, drawing = false, lastX = 0, lastY = 0;

      function setupCanvas(){
        const dpr = window.devicePixelRatio || 1;
        const width = canvas.clientWidth;
        const height = 200;
        canvas.width = Math.floor(width * dpr);
        canvas.height = Math.floor(height * dpr);
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        ctx.lineWidth = 2.5;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = '#111827';
      }

      function pointerPosition(e){
        const rect = canvas.getBoundingClientRect();
        return { x: e.clientX - rect.left, y: e.clientY - rect.top };
      }

      canvas.addEventListener('pointerdown', (e)=>{
        e.preventDefault();
        drawing = true;
        const pos = pointerPosition(e);
        lastX = pos.x; lastY = pos.y;
      });

      canvas.addEventListener('pointermove', (e)=>{
        if (!drawing) return;
        e.preventDefault();
        const pos = pointerPosition(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x; lastY = pos.y;
      });

      window.addEventListener('pointerup', ()=> drawing = false);
      clearBtn.addEventListener('click', ()=> ctx && ctx.clearRect(0, 0, canvas.width, canvas.height));

      function openModal(){
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        setupCanvas();
        nameEl.focus();
        document.body.style.overflow = 'hidden';
      }

      function closeModal(){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = '';
      }

      openBtn?.addEventListener('click', openModal);
      closeBtn?.addEventListener('click', closeModal);
      modal?.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
      window.addEventListener('resize', ()=>{ if (!modal.classList.contains('hidden')) setupCanvas(); });

      saveBtn?.addEventListener('click', async ()=>{
        const name = (nameEl.value || '').trim();
        const role = (roleEl.value || '').trim();
        if (!name){ alert('Enter the signer name.'); return; }
        const exportCanvas = document.createElement('canvas');
        exportCanvas.width = canvas.width;
        exportCanvas.height = canvas.height;
        const exportCtx = exportCanvas.getContext('2d');
        exportCtx.drawImage(canvas, 0, 0);
        const dataURL = exportCanvas.toDataURL('image/png');
        try {
          const resp = await fetch('{{ url_for('behaviour_bp.add_signature_api') }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              entity_type: 'counseling_session',
              entity_id: {{ session.id }},
              signer_name: name,
              signer_role: role,
              image_data: dataURL
            })
          });
          if (!resp.ok){
            const j = await resp.json().catch(()=>({}));
            throw new Error(j.error || 'Failed to save signature');
          }
          window.location.reload();
        } catch (err){
          alert(err.message || err);
        }
      });
    })();
  </script>
</body>
</html>
